---
// src/pages/index.astro
import BaseLayout from '../layouts/BaseLayout.astro';
import FilterBar from '../components/FilterBar.astro';
import PropertyCard from '../components/PropertyCard.astro';
import { searchProperties } from '../lib/api';

const { results } = await searchProperties({});
const properties = results;
---
<BaseLayout>
  <FilterBar />

  <div class="list-controls">
    <p class="result-count" id="result-count">
      <span id="count-num">{properties.length}</span> properties found
    </p>
  </div>

  <div class="prop-grid" id="prop-grid">
    {properties.map(p => (
      <div
        class="grid-item"
        data-title={p.title.toLowerCase()}
        data-location={p.location.toLowerCase()}
        data-tenure={p.tenure}
        data-type={p.property_type}
        data-price={p.price}
        data-beds={p.bedrooms}
      >
        <PropertyCard property={p} />
      </div>
    ))}
  </div>

  <div id="no-results" class="no-results" style="display:none">
    <span>ğŸ”</span>
    <p>No properties match your filters.</p>
    <button onclick="resetFilters()">Clear Filters</button>
  </div>
</BaseLayout>

<style>
.list-controls {
  max-width: 1400px;
  margin: 1.5rem auto 0.5rem;
  padding: 0 2rem;
}
.result-count { font-size: 1rem; font-weight: 600; color: var(--hl-grey); }
.prop-grid {
  max-width: 1400px;
  margin: 1rem auto 2rem;
  padding: 0 2rem;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(310px, 1fr));
  gap: 1.5rem;
}
.no-results {
  max-width: 400px;
  margin: 3rem auto;
  text-align: center;
  color: var(--hl-grey);
}
.no-results span { font-size: 3rem; display: block; margin-bottom: 0.75rem; }
.no-results p   { font-size: 1.1rem; margin-bottom: 1rem; }
.no-results button {
  padding: 0.75rem 2rem;
  background: var(--hl-cyan);
  color: white;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
}
@media (max-width: 680px) {
  .prop-grid { grid-template-columns: 1fr; padding: 0 1rem; }
}
</style>

<script>
  // â”€â”€ Tenure toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let activeTenure = 'sale';

  document.querySelectorAll('#tenure-toggle .toggle-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('#tenure-toggle .toggle-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      activeTenure = (btn as HTMLElement).dataset.value ?? 'all';
      applyFilters();
    });
  });

  // â”€â”€ Apply filters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function applyFilters() {
    const type    = (document.getElementById('filter-type') as HTMLSelectElement)?.value ?? 'all';
    const minP    = parseFloat((document.getElementById('filter-min') as HTMLSelectElement)?.value) || 0;
    const maxP    = parseFloat((document.getElementById('filter-max') as HTMLSelectElement)?.value) || Infinity;
    const beds    = parseInt((document.getElementById('filter-beds') as HTMLSelectElement)?.value) || 0;
    const keyword = (document.getElementById('filter-keyword') as HTMLInputElement)?.value.toLowerCase().trim();

    const items = document.querySelectorAll<HTMLElement>('.grid-item');
    let visible = 0;

    items.forEach(item => {
      const tenure   = item.dataset.tenure ?? '';
      const itemType = item.dataset.type ?? '';
      const price    = parseFloat(item.dataset.price ?? '0');
      const itemBeds = parseInt(item.dataset.beds ?? '0');
      const title    = item.dataset.title ?? '';
      const location = item.dataset.location ?? '';

      const tenureOk  = activeTenure === 'all' || tenure === activeTenure;
      const typeOk    = type === 'all' || itemType === type;
      const priceOk   = price >= minP && price <= maxP;
      const bedsOk    = itemBeds >= beds;
      const keyOk     = !keyword || title.includes(keyword) || location.includes(keyword);

      const show = tenureOk && typeOk && priceOk && bedsOk && keyOk;
      item.style.display = show ? '' : 'none';
      if (show) visible++;
    });

    const countEl = document.getElementById('count-num');
    if (countEl) countEl.textContent = String(visible);

    const noResults = document.getElementById('no-results');
    if (noResults) noResults.style.display = visible === 0 ? 'block' : 'none';
  }

  // Apply on search button
  document.getElementById('filter-apply')?.addEventListener('click', applyFilters);

  // Live keyword search
  document.getElementById('filter-keyword')?.addEventListener('input', applyFilters);

  // Expose reset for "Clear Filters" button
  (window as any).resetFilters = () => {
    activeTenure = 'all';
    document.querySelectorAll('#tenure-toggle .toggle-btn').forEach(b => b.classList.remove('active'));
    (document.querySelector('#tenure-toggle .toggle-btn[data-value="all"]') as HTMLElement)?.classList.add('active');
    (document.getElementById('filter-type') as HTMLSelectElement).value = 'all';
    (document.getElementById('filter-min') as HTMLSelectElement).value  = '';
    (document.getElementById('filter-max') as HTMLSelectElement).value  = '';
    (document.getElementById('filter-beds') as HTMLSelectElement).value = '';
    (document.getElementById('filter-keyword') as HTMLInputElement).value = '';
    applyFilters();
  };

  // Trigger initial filter to show only 'sale' items on load
  applyFilters();
</script>
