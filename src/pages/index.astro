---
import BaseLayout from '../layouts/BaseLayout.astro';
import FilterBar from '../components/FilterBar.astro';
import PropertyCard from '../components/PropertyCard.astro';
---

<BaseLayout title="HomeLinx ‚Äî Property Discovery" description="Residential and Commercial properties for sale or rent.">
  <FilterBar />

  <section class="results">
    <div class="results-inner">
      <div class="results-header">
        <div class="results-count" id="resultsCount">No search run yet</div>
      </div>

      <div class="results-grid" id="resultsGrid"></div>

      <div class="empty-state" id="emptyState">
        <div class="empty-icon">üè†</div>
        <h3>Ready when you are</h3>
        <p>
          Choose your filters above, then press <strong>Search</strong>.
        </p>
        <p class="empty-sub" id="emptySub">
          If nothing appears, there are currently no requested search options available yet.
        </p>
      </div>
    </div>
  </section>

  <style>
    .results {
      padding: 2rem 1.5rem;
    }
    .results-inner {
      max-width: 1400px;
      margin: 0 auto;
    }
    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.25rem;
    }
    .results-count {
      font-size: 1rem;
      font-weight: 700;
      color: var(--hl-grey);
    }
    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 1.25rem;
    }
    .empty-state {
      text-align: center;
      padding: 3.5rem 1.5rem;
      background: var(--hl-white);
      border: 1px solid var(--hl-border);
      border-radius: 12px;
      box-shadow: var(--hl-shadow);
    }
    .empty-icon {
      font-size: 3rem;
      margin-bottom: 0.75rem;
    }
    .empty-state h3 {
      font-size: 1.4rem;
      margin-bottom: 0.75rem;
      color: var(--hl-dark);
    }
    .empty-state p {
      color: var(--hl-grey);
      margin: 0.35rem 0;
      line-height: 1.6;
    }
    .empty-sub {
      opacity: 0.9;
      font-size: 0.95rem;
    }
  </style>

  <script>
    const BASE_URL = import.meta.env.PUBLIC_VTL_API_URL;

    const resultsGrid  = document.getElementById('resultsGrid');
    const resultsCount = document.getElementById('resultsCount');
    const emptyState   = document.getElementById('emptyState');
    const emptySub     = document.getElementById('emptySub');

    // Holds latest chosen filters from FilterBar
    let currentFilters = {
      listing: 'sale',            // sale|rent
      propertyClass: 'residential',// residential|commercial
      propertyType: 'all',         // all|Flat|Office|...
      minPrice: null,
      maxPrice: null,
      beds: null,
      keyword: null,
    };

    function setEmpty(message, sub = '') {
      resultsGrid.innerHTML = '';
      emptyState.style.display = 'block';
      resultsCount.textContent = message;
      if (sub) emptySub.textContent = sub;
    }

    function hideEmpty() {
      emptyState.style.display = 'none';
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    function renderResults(payload) {
      const results = payload?.results ?? [];
      const count = payload?.count ?? results.length ?? 0;

      resultsCount.textContent = `${count} propert${count === 1 ? 'y' : 'ies'} found`;

      if (!count) {
        setEmpty('0 properties found', 'Try widening your search or adjusting filters.');
        return;
      }

      hideEmpty();
      resultsGrid.innerHTML = '';

      // Render using your existing PropertyCard component markup expectations:
      // We keep it generic by creating cards as links and letting PropertyCard handle display
      // If your PropertyCard requires different props, we can align next.
      results.forEach((p) => {
        const wrap = document.createElement('div');
        wrap.innerHTML = `
          <a class="card-link" href="/property/${encodeURIComponent(p.id)}" aria-label="${escapeHtml(p.title || 'Property')}">
            <div class="card-mount"></div>
          </a>
        `;

        // Mount point
        const mount = wrap.querySelector('.card-mount');

        // Minimal fallback if PropertyCard can't be mounted client-side (Astro components are server-rendered)
        // So we render a simple HTML card here. Keeps the page functional with zero extra drift.
        mount.innerHTML = `
          <div class="simple-card">
            ${p.image ? `<div class="img" style="background-image:url('${escapeHtml(p.image)}')"></div>` : `<div class="img placeholder"></div>`}
            <div class="body">
              <div class="title">${escapeHtml(p.title || 'Untitled')}</div>
              ${p.location ? `<div class="meta">${escapeHtml(p.location)}</div>` : ``}
              ${p.summary ? `<div class="summary">${escapeHtml(p.summary)}</div>` : ``}
              <div class="foot">
                ${typeof p.price === 'number' ? `<span class="price">¬£${new Intl.NumberFormat('en-GB').format(p.price)}</span>` : `<span class="price muted">Price on request</span>`}
                ${(p.bedrooms ? `<span class="pill">${p.bedrooms} bed</span>` : ``)}
                ${(p.bathrooms ? `<span class="pill">${p.bathrooms} bath</span>` : ``)}
              </div>
            </div>
          </div>
        `;

        resultsGrid.appendChild(wrap.firstElementChild);
      });
    }

    // Basic card styling (kept local to this page)
    const style = document.createElement('style');
    style.textContent = `
      .card-link { text-decoration:none; color:inherit; display:block; }
      .simple-card {
        background: var(--hl-white);
        border: 1px solid var(--hl-border);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: var(--hl-shadow);
        transition: transform .15s ease, box-shadow .15s ease;
      }
      .simple-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 24px rgba(0,0,0,.08);
      }
      .simple-card .img {
        height: 180px;
        background-size: cover;
        background-position: center;
        background-color: var(--hl-light);
      }
      .simple-card .img.placeholder {
        background-image: linear-gradient(135deg, rgba(0,0,0,.04), rgba(0,0,0,.02));
      }
      .simple-card .body { padding: 1rem; }
      .simple-card .title { font-weight: 800; font-size: 1.05rem; margin-bottom: .35rem; color: var(--hl-dark); }
      .simple-card .meta { color: var(--hl-grey); font-size: .9rem; margin-bottom: .5rem; }
      .simple-card .summary { color: var(--hl-grey); font-size: .95rem; line-height: 1.5; margin-bottom: .75rem; }
      .simple-card .foot { display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; }
      .simple-card .price { font-weight: 900; color: var(--hl-cyan); }
      .simple-card .price.muted { color: var(--hl-grey); font-weight: 800; }
      .simple-card .pill {
        padding: .25rem .55rem;
        border-radius: 999px;
        border: 1px solid var(--hl-border);
        color: var(--hl-grey);
        font-size: .8rem;
        font-weight: 700;
        background: var(--hl-light);
      }
    `;
    document.head.appendChild(style);

    async function runSearch() {
      if (!BASE_URL) {
        setEmpty('API not connected', 'Set PUBLIC_VTL_API_URL in Cloudflare Pages to enable live listings.');
        return;
      }

      // Build query params expected by your future listing-driven API.
      // These keys are stable and unambiguous.
      const qs = new URLSearchParams();

      qs.set('listing', currentFilters.listing);               // sale|rent
      qs.set('class', currentFilters.propertyClass);           // residential|commercial

      if (currentFilters.propertyType && currentFilters.propertyType !== 'all') {
        qs.set('type', currentFilters.propertyType);
      }

      if (currentFilters.minPrice) qs.set('min_price', String(currentFilters.minPrice));
      if (currentFilters.maxPrice) qs.set('max_price', String(currentFilters.maxPrice));

      // Beds only for residential
      if (currentFilters.propertyClass === 'residential' && currentFilters.beds) {
        qs.set('min_beds', String(currentFilters.beds));
      }

      if (currentFilters.keyword) qs.set('q', currentFilters.keyword);

      resultsCount.textContent = 'Searching‚Ä¶';
      hideEmpty();

      try {
        const res = await fetch(`${BASE_URL}/properties?${qs.toString()}`);
        if (!res.ok) throw new Error(`API error ${res.status}`);
        const payload = await res.json();
        renderResults(payload);
      } catch (err) {
        console.error(err);
        setEmpty('Search failed', 'Check PUBLIC_VTL_API_URL and the /properties endpoint.');
      }
    }

    // Receive filter state from FilterBar
    window.addEventListener('filters:changed', (ev) => {
      const d = ev.detail || {};
      currentFilters = {
        listing: d.listing || 'sale',
        propertyClass: d.propertyClass || 'residential',
        propertyType: d.propertyType || 'all',
        minPrice: d.minPrice ? Number(d.minPrice) : null,
        maxPrice: d.maxPrice ? Number(d.maxPrice) : null,
        beds: d.beds ? Number(d.beds) : null,
        keyword: d.keyword || null,
      };
    });

    // Hook the Search button (it exists inside FilterBar)
    function hookSearchButton() {
      const btn = document.getElementById('filter-apply');
      if (!btn) return;
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        runSearch();
      });
    }

    // Init: no auto-search. Just wire the button.
    hookSearchButton();
  </script>
</BaseLayout>